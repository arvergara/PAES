import { useState, useEffect } from 'react';
import { Toaster } from 'react-hot-toast';
import { BookOpen, FlaskConical, Atom, Leaf, Target } from 'lucide-react';
import { Header } from './components/Header';
import { SubjectCard } from './components/SubjectCard';
import { ModeSelector } from './components/ModeSelector';
import { TestMode } from './components/TestMode';
import { ReadingTestMode } from './components/ReadingTestMode';
import { PAESMode } from './components/PAESMode';
import { ReviewMode } from './components/ReviewMode';
import { StrengthsModal } from './components/StrengthsModal';
import { useTimeSettings } from './components/SettingsMenu';
import { useTheme } from './contexts/ThemeContext';
import { LandingPage } from './components/LandingPage';
import { useAuth } from './hooks/useAuth';
import { TopBannersSection } from './components/TopBannersSection';
import type { Subject, PracticeMode } from './types';

type AppState = 'subject' | 'science-specialty' | 'mode' | 'practice';
type ScienceSpecialty = 'CF' | 'CQ' | 'CB';

const subjects: Subject[] = ['M1', 'M2', 'L', 'C', 'H'];

const scienceSpecialties = [
  { code: 'CF' as ScienceSpecialty, name: 'Física', icon: Atom, description: 'Mecánica, ondas, electricidad y más', color: 'text-cyan-600 dark:text-cyan-400', iconBg: 'bg-cyan-100 dark:bg-cyan-500/20', borderHover: 'hover:border-cyan-400 dark:hover:border-cyan-500/50', bgColor: 'bg-cyan-50 dark:bg-cyan-500/10', borderColor: 'border-cyan-200 dark:border-cyan-500/30' },
  { code: 'CQ' as ScienceSpecialty, name: 'Química', icon: FlaskConical, description: 'Reacciones, estequiometría y química orgánica', color: 'text-purple-600 dark:text-purple-400', iconBg: 'bg-purple-100 dark:bg-purple-500/20', borderHover: 'hover:border-purple-400 dark:hover:border-purple-500/50', bgColor: 'bg-purple-50 dark:bg-purple-500/10', borderColor: 'border-purple-200 dark:border-purple-500/30' },
  { code: 'CB' as ScienceSpecialty, name: 'Biología', icon: Leaf, description: 'Célula, genética, evolución y ecología', color: 'text-green-600 dark:text-green-400', iconBg: 'bg-green-100 dark:bg-green-500/20', borderHover: 'hover:border-green-400 dark:hover:border-green-500/50', bgColor: 'bg-green-50 dark:bg-green-500/10', borderColor: 'border-green-200 dark:border-green-500/30' },
];

// Interfaz para sesión guardada
interface SavedSession {
  subject: Subject;
  mode: PracticeMode;
  questionIndex: number;
  timeRemaining: number;
  totalQuestions: number;
  timestamp: number;
  questionIds?: string[];
  answers?: Record<number, string>;
  userId?: string; // Nuevo: identificador del usuario
}

function App() {
  const { user, loading } = useAuth();

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
        <div className="w-12 h-12 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
      </div>
    );
  }

  if (!user) {
    return (
      <>
        <Toaster position="top-center" />
        <LandingPage />
      </>
    );
  }

  return <AuthenticatedApp userId={user.id} />;
}

// Nuevo: AuthenticatedApp recibe userId como prop
interface AuthenticatedAppProps {
  userId: string;
}

function AuthenticatedApp({ userId }: AuthenticatedAppProps) {
  const [state, setState] = useState<AppState>('subject');
  const [selectedSubject, setSelectedSubject] = useState<Subject | null>(null);
  const [selectedMode, setSelectedMode] = useState<PracticeMode | null>(null);
  const [resumeData, setResumeData] = useState<SavedSession | null>(null);
  const [showStrengthsModal, setShowStrengthsModal] = useState(false);
  const { theme } = useTheme();
  const { 
    settings: timeSettings, 
    updateSetting,
    updateAllSettings,
    updatePaesQuestions,
    updateAllPaesQuestions,
    updateReadingTime,
    updateAllReadingTime,
    updateReviewQuestions,
    updateAllReviewQuestions,
    getTimeForSubject, 
    getPaesQuestionsForSubject,
    getReadingTimeForSubject,
    getReviewQuestionsForSubject
  } = useTimeSettings();

  // Escuchar evento openStrengths
  useEffect(() => {
    const handleOpenStrengths = () => setShowStrengthsModal(true);
    window.addEventListener('openStrengths', handleOpenStrengths);
    return () => window.removeEventListener('openStrengths', handleOpenStrengths);
  }, []);

  const handleSubjectSelect = (subject: Subject) => {
    setSelectedSubject(subject);
    setResumeData(null);
    if (subject === 'C') {
      setState('science-specialty');
    } else {
      setState('mode');
    }
  };

  const handleScienceSpecialtySelect = (specialty: ScienceSpecialty) => {
    setSelectedSubject(specialty);
    setResumeData(null);
    setState('mode');
  };

  const handleModeSelect = (mode: PracticeMode) => {
    setSelectedMode(mode);
    setState('practice');
  };

  const handleExit = () => {
    setState('subject');
    setSelectedSubject(null);
    setSelectedMode(null);
    setResumeData(null);
  };

  const handleBackToSubjects = () => {
    setState('subject');
    setSelectedSubject(null);
  };

  const handleBackToSpecialty = () => {
    setState('science-specialty');
    setSelectedSubject('C');
  };

  // Handler para continuar sesión desde ContinueButton
  const handleContinueSession = (subject: Subject, mode: PracticeMode, questionIndex?: number, timeRemaining?: number) => {
    const sessionData = localStorage.getItem('lastPracticeSession');
    if (sessionData) {
      const session: SavedSession = JSON.parse(sessionData);
      // Verificar que la sesión pertenece al usuario actual
      if (session.userId === userId) {
        setResumeData(session);
      }
    }
    setSelectedSubject(subject);
    setSelectedMode(mode);
    setState('practice');
  };

  // Handler para guardar sesión cuando el usuario sale de TestMode
  const handleSessionChange = (session: any | null) => {
    if (session) {
      const savedSession: SavedSession = {
        subject: session.subject,
        mode: session.mode,
        questionIndex: session.currentQuestionIndex + 1,
        timeRemaining: session.timeRemaining,
        totalQuestions: session.totalQuestions,
        timestamp: Date.now(),
        questionIds: session.questionIds,
        answers: session.answers,
        userId: userId, // Nuevo: guardar el userId con la sesión
      };
      localStorage.setItem('lastPracticeSession', JSON.stringify(savedSession));
    } else {
      localStorage.removeItem('lastPracticeSession');
    }
  };

  const renderContent = () => {
    if (state === 'practice' && selectedSubject && selectedMode) {
      const configSubject = ['CF', 'CQ', 'CB'].includes(selectedSubject) ? 'C' : selectedSubject;
      const testTime = getTimeForSubject('test', configSubject as Subject);
      const paesTime = getTimeForSubject('paes', configSubject as Subject);
      const paesQuestions = getPaesQuestionsForSubject(configSubject as Subject);
      const readingTime = getReadingTimeForSubject(configSubject as Subject);
      const reviewQuestions = getReviewQuestionsForSubject(configSubject as Subject);
      
      if (selectedMode === 'PAES') {
        return (
          <PAESMode 
            subject={selectedSubject} 
            onExit={handleExit} 
            timePerQuestion={paesTime}
            questionCount={paesQuestions}
            onSessionChange={handleSessionChange}
          />
        );
      }
      if (selectedMode === 'REVIEW') {
        return (
          <ReviewMode 
            subject={selectedSubject} 
            onExit={handleExit}
            questionCount={reviewQuestions}
          />
        );
      }
      if (selectedSubject === 'L') {
        return (
          <ReadingTestMode 
            subject={selectedSubject} 
            onExit={handleExit} 
            timePerQuestion={testTime}
            readingTime={readingTime}
          />
        );
      }
      
      const resumeSession = resumeData && resumeData.subject === selectedSubject ? {
        subject: resumeData.subject,
        mode: resumeData.mode as 'TEST',
        currentQuestionIndex: resumeData.questionIndex - 1,
        timeRemaining: resumeData.timeRemaining,
        answers: resumeData.answers || {},
        questionIds: resumeData.questionIds || [],
        startTime: Date.now(),
        totalQuestions: resumeData.totalQuestions,
        pausedAt: resumeData.timestamp,
        subjectLabel: selectedSubject,
      } : undefined;
      
      return (
        <TestMode 
          subject={selectedSubject} 
          onExit={handleExit} 
          timePerQuestion={testTime}
          resumeSession={resumeSession}
          onSessionChange={handleSessionChange}
        />
      );
    }

    if (state === 'science-specialty') {
      return (
        <div>
          <button
            onClick={handleBackToSubjects}
            className="mb-6 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors text-sm font-medium"
          >
            ← Volver a materias
          </button>
          <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-2 text-center">Ciencias</h2>
          <p className="text-gray-500 dark:text-gray-400 mb-8 text-center text-sm">Selecciona tu especialidad</p>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-4xl mx-auto">
            {scienceSpecialties.map((specialty) => {
              const Icon = specialty.icon;
              return (
                <button
                  key={specialty.code}
                  onClick={() => handleScienceSpecialtySelect(specialty.code)}
                  className={`group text-left ${specialty.bgColor} rounded-2xl border ${specialty.borderColor} ${specialty.borderHover} shadow-sm hover:shadow-lg transition-all duration-300 p-6`}
                >
                  <div className={`inline-flex p-3 ${specialty.iconBg} rounded-xl mb-4`}>
                    <Icon className={`w-6 h-6 ${specialty.color}`} />
                  </div>
                  <h3 className={`text-lg font-bold ${specialty.color} mb-1`}>{specialty.name}</h3>
                  <p className="text-sm text-gray-600 dark:text-gray-400">{specialty.description}</p>
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    if (state === 'mode' && selectedSubject) {
      const isScienceSpecialty = ['CF', 'CQ', 'CB'].includes(selectedSubject);
      return (
        <div>
          <button
            onClick={isScienceSpecialty ? handleBackToSpecialty : handleBackToSubjects}
            className="mb-6 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors text-sm font-medium"
          >
            ← Volver a {isScienceSpecialty ? 'especialidades' : 'materias'}
          </button>
          <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-6 text-center">Selecciona un modo de práctica</h2>
          <ModeSelector onSelect={handleModeSelect} />
        </div>
      );
    }

    return (
      <div>
        <h2 className="text-xl font-semibold text-gray-900 dark:text-white mb-6 text-center">Selecciona una materia</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-5xl mx-auto">
          {subjects.map((subject) => (
            <SubjectCard key={subject} subject={subject} onSelect={handleSubjectSelect} />
          ))}
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
      <Toaster position="top-center" />
      <Header 
        timeSettings={timeSettings} 
        onUpdateTimeSetting={updateSetting}
        onUpdateAllTimeSettings={updateAllSettings}
        onUpdatePaesQuestions={updatePaesQuestions}
        onUpdateAllPaesQuestions={updateAllPaesQuestions}
        onUpdateReadingTime={updateReadingTime}
        onUpdateAllReadingTime={updateAllReadingTime}
        onUpdateReviewQuestions={updateReviewQuestions}
        onUpdateAllReviewQuestions={updateAllReviewQuestions}
        showHomeButton={state !== 'subject'}
        onGoHome={handleExit}
      />
      <main className="container mx-auto px-4 py-8">
        {state === 'subject' && (
          <TopBannersSection onContinue={handleContinueSession} userId={userId} />
        )}
        {renderContent()}
        
        {state === 'subject' && (
          <div className="max-w-5xl mx-auto mt-8">
            <button 
              onClick={() => setShowStrengthsModal(true)} 
              className="w-full flex items-center justify-center gap-3 p-4 bg-rose-50 dark:bg-rose-500/10 rounded-xl border border-rose-200 dark:border-rose-500/30 hover:border-rose-400 dark:hover:border-rose-500/50 hover:bg-rose-100 dark:hover:bg-rose-500/20 shadow-sm hover:shadow-md transition-all duration-300 group"
            >
              <Target className="w-5 h-5 text-rose-600 dark:text-rose-400" />
              <span className="font-semibold text-rose-700 dark:text-rose-300 group-hover:text-rose-800 dark:group-hover:text-rose-200 transition-colors">¿Qué materias debo reforzar?</span>
            </button>
          </div>
        )}
      </main>

      <a
        href="/resumenes.html"
        target="_blank"
        rel="noopener noreferrer"
        className="fixed bottom-6 right-6 flex items-center gap-2 px-4 py-2.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-500/50 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 z-50"
      >
        <BookOpen className="w-4 h-4 text-indigo-600 dark:text-indigo-400" />
        <span className="text-gray-700 dark:text-gray-200 font-medium text-sm">Resúmenes PAES</span>
      </a>

      {/* Modal de análisis de fortalezas */}
      <StrengthsModal 
        isOpen={showStrengthsModal}
        onClose={() => setShowStrengthsModal(false)}
        onSelectSubject={handleSubjectSelect}
      />
    </div>
  );
}

export default App;